#!/usr/bin/env bash

# Combined script to install Homebrew and create taps

# Check if Command Line Tools are installed, run install_clt if not
echo "==> Checking for Command Line Tools..."
if [ ! -x "/Library/Developer/CommandLineTools/usr/bin/clang" ]; then
	echo "==> Command Line Tools not found, running install_clt..."
	SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	"${SCRIPT_DIR}/install_clt"
	CLT_STATUS=$?
	if [ $CLT_STATUS -ne 0 ]; then
		echo "ERROR: Command Line Tools installation failed with status $CLT_STATUS"
		exit $CLT_STATUS
	fi
	echo "==> Command Line Tools installed successfully"
else
	echo "==> Command Line Tools already installed"
fi

# Set paths for Intel Mac
export HOMEBREW_PREFIX="/usr/local"
export HOMEBREW_REPOSITORY="/usr/local/Homebrew"

echo "==> Creating Homebrew directory structure..."
sudo mkdir -p "${HOMEBREW_REPOSITORY}"
sudo mkdir -p "${HOMEBREW_PREFIX}"/{bin,etc,include,lib,sbin,share,var,opt,Frameworks,Cellar,var/homebrew/linked}

# shellcheck disable=SC2312
sudo chown -R "$(whoami)":wheel "${HOMEBREW_REPOSITORY}" "${HOMEBREW_PREFIX}"/{bin,etc,include,lib,sbin,share,var,opt,Frameworks,Cellar,var/homebrew/linked}

echo "==> Cloning Homebrew repository..."
# Clone from your local repository
git clone --depth=1 file:///Volumes/Monterey/repos/homebrew /usr/local/Homebrew
cd /usr/local/Homebrew || exit
git config advice.detachedHead false
cd || exit

echo "==> Creating symlink..."
# Create symlink
sudo ln -s /usr/local/Homebrew/bin/brew /usr/local/bin/

echo "==> Configuring PATH..."
# Add to PATH (if not already there)
if [[ ! ${PATH} =~ "/usr/local/bin" ]]; then
	# shellcheck disable=SC2016
	echo 'export PATH="/usr/local/bin:${PATH}"' >>~/.zshrc
fi

cat /Volumes/Monterey/zshrc.example >>~/.zshrc

echo "==> Creating taps directory structure..."
# Create taps directory structure
mkdir -p /usr/local/Homebrew/Library/Taps/homebrew

echo "==> Cloning homebrew-core tap..."
# Clone homebrew-core from your share
git clone --depth=1 file:///Volumes/Monterey/repos/homebrew-core \
	/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core
cd /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core || exit
git config advice.detachedHead false

# Get the core commit hash and apply patches if available
CORE_HASH=$(git rev-parse --short=11 HEAD)
CORE_PATCH="/Volumes/Monterey/repos/core-diffs-for-${CORE_HASH}"
if [ -f "$CORE_PATCH" ] && [ -s "$CORE_PATCH" ]; then
	echo "==> Applying patches to homebrew-core from $(basename "$CORE_PATCH")..."
	if git apply "$CORE_PATCH"; then
		echo "==> Core patches applied successfully"
	else
		echo "WARNING: Failed to apply core patches"
	fi
else
	echo "==> No core patches to apply (file empty or not found: $CORE_PATCH)"
fi

cd || exit

echo "==> Verifying tap..."
# Verify tap is recognized
brew tap

echo "==> Cloning homebrew-cask tap..."
git clone file:///Volumes/Monterey/repos/homebrew-cask \
	/usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask
cd /usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask || exit
git config advice.detachedHead false

# Get the cask commit hash and apply patches if available
CASK_HASH=$(git rev-parse --short=11 HEAD)
CASK_PATCH="/Volumes/Monterey/repos/cask-diffs-for-${CASK_HASH}"
if [ -f "$CASK_PATCH" ] && [ -s "$CASK_PATCH" ]; then
	echo "==> Applying patches to homebrew-cask from $(basename "$CASK_PATCH")..."
	if git apply "$CASK_PATCH"; then
		echo "==> Cask patches applied successfully"
	else
		echo "WARNING: Failed to apply cask patches"
	fi
else
	echo "==> No cask patches to apply (file empty or not found: $CASK_PATCH)"
fi

cd || exit

echo "==> Running brew doctor..."
brew doctor

echo "==> Installation complete!"
