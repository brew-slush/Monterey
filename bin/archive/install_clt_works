#!/usr/bin/env bash

set -e

# === CONFIGURATION ===
SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
MOUNT="$( cd "${SCRIPT_DIR}/.." && pwd )"

# Architecture detection
ARCH=$(uname -m)
PROC=$([[ "$ARCH" == "arm64" ]] && echo "ARM" || echo "Intel")
echo "Architecture: $ARCH, Processor: $PROC"

# === ARGUMENT HANDLING ===
USER_DMG_PATH="${1:-}"

if [ -n "$USER_DMG_PATH" ]; then
    DMG_PATH="$USER_DMG_PATH"
else
    DMG_PATH=$(find "${MOUNT}/software/${PROC}" -name "Command_Line_Tools_*.dmg" -type f | head -n1)
fi

echo "Using DMG: $DMG_PATH"

if [ ! -f "$DMG_PATH" ]; then 
    echo "Error: DMG not found at $DMG_PATH" >&2
    exit 1
fi

if [ ! -r "$DMG_PATH" ]; then
    echo "Error: DMG not readable" >&2
    ls -la "$DMG_PATH" >&2
    exit 1
fi

# === FUNCTIONS ===
cleanup() {
    if [ "${MOUNTED_IN_SCRIPT:-false}" = "true" ] && [ -n "${MOUNT_PATH:-}" ]; then
        echo "Cleaning up mount: $MOUNT_PATH"
        hdiutil detach "$MOUNT_PATH" 2>/dev/null || true
    fi
    rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress 2>/dev/null || true
}

is_installed() {
    pkgutil --pkg-info com.apple.pkg.CLTools_Executables &>/dev/null || \
    [ -e "/Library/Developer/CommandLineTools/usr/bin/clang" ]
}

# === MAIN ===
main() {
    echo "=== Command Line Tools Installer ==="
    
    if is_installed; then
        echo "✓ Command Line Tools already installed."
        if path=$(xcode-select --print-path 2>/dev/null); then
            echo "  Path: $path"
        fi
        exit 0
    fi

    echo "✓ Command Line Tools not installed. Proceeding with installation..."
    
    # Create progress file to suppress GUI
    echo "  Creating progress indicator file..."
    sudo touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
    
    # Clean up any existing mounts
    echo "  Checking for existing mounts..."
    EXISTING_MOUNTS=$(hdiutil info | grep -B 5 "$DMG_PATH" | grep '^/Volumes/' | awk '{print $NF}' || true)
    
    if [ -n "$EXISTING_MOUNTS" ]; then
        echo "  Found existing mounts, unmounting..."
        echo "$EXISTING_MOUNTS" | while IFS= read -r mount_point; do
            if [ -n "$mount_point" ]; then
                echo "    Unmounting $mount_point..."
                hdiutil detach "$mount_point" 2>/dev/null || true
            fi
        done
        sleep 2
    fi
    
    # Mount DMG
    echo "  Mounting DMG..."
    MOUNT_PATH="/Volumes/CLT_$$"
    
    if ! hdiutil mount -readonly -quiet -nobrowse -mountpoint "$MOUNT_PATH" "$DMG_PATH"; then
        echo "  Mount failed. Trying standard attach..." >&2
        MOUNT_OUTPUT=$(hdiutil attach -nobrowse "$DMG_PATH" 2>&1)
        
        if [ $? -ne 0 ]; then
            echo "  ERROR: Failed to mount DMG" >&2
            echo "  hdiutil output: $MOUNT_OUTPUT" >&2
            exit 1
        fi
        
        MOUNTED_IN_SCRIPT=true
        MOUNT_PATH=$(echo "$MOUNT_OUTPUT" | grep '/Volumes/' | awk '{print $NF}' | tail -n1)
        
        if [ -z "$MOUNT_PATH" ]; then
            # Fallback: search for mount
            sleep 1
            MOUNT_PATH=$(find /Volumes -maxdepth 1 -type d -name "*Command*Line*" | head -n1)
        fi
    else
        MOUNTED_IN_SCRIPT=true
    fi
    
    # Verify mount
    if [ ! -d "$MOUNT_PATH" ]; then
        echo "  ERROR: Mount point doesn't exist: $MOUNT_PATH" >&2
        echo "  Current mounts:"
        mount | grep -i command >&2
        exit 1
    fi
    
    echo "  Mounted at: $MOUNT_PATH"
    
    # Find package
    PKG_PATH=$(find "$MOUNT_PATH" -maxdepth 1 -name "*.pkg" -type f | head -n1)
    if [ -z "$PKG_PATH" ]; then
        echo "  ERROR: No .pkg file found in $MOUNT_PATH" >&2
        echo "  Contents:"
        ls -la "$MOUNT_PATH" >&2
        exit 1
    fi
    
    echo "  Found package: $(basename "$PKG_PATH")"
    echo "  Starting installation (this may take 5-10 minutes)..."
    echo "  Log file: /tmp/clt_install.log"
    
    # Run installer with output to both screen and log
    if ! sudo installer -pkg "$PKG_PATH" -target / -verboseR > /tmp/clt_install.log 2>&1; then
        echo "  ERROR: Installer failed" >&2
        echo "  Last 20 lines of log:" >&2
        tail -20 /tmp/clt_install.log >&2
        exit 1
    fi
    
    # Show the end of the log to confirm completion
    echo "  Installation completed. Last log lines:"
    tail -5 /tmp/clt_install.log
    
    echo ""
    echo "  Verifying installation..."
    if is_installed; then
        echo "✓ Command Line Tools installed successfully!"
        if path=$(xcode-select --print-path 2>/dev/null); then
            echo "  Path: $path"
        fi
    else
        echo "✗ Installation verification failed" >&2
        exit 1
    fi
    
    echo "=== Installation Complete ==="
}

# Set up trap and run
trap cleanup EXIT
main "$@"
