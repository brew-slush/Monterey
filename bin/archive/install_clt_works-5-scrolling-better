#!/usr/bin/env bash

set -e

# === FUNCTIONS ===
cleanup() {
    if [ "${MOUNTED_IN_SCRIPT:-false}" = "true" ] && [ -n "${MOUNT_PATH:-}" ]; then
        echo "  Cleaning up mount: $MOUNT_PATH" >&2
        hdiutil detach "$MOUNT_PATH" 2>/dev/null || true
    fi
    rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress 2>/dev/null || true
}

kill_installer_and_tail() {
    if [ -n "${TAIL_PID:-}" ]; then
        kill $TAIL_PID 2>/dev/null || true
        wait $TAIL_PID 2>/dev/null || true
    fi
    if [ -n "${INSTALLER_PID:-}" ]; then
        sudo kill $INSTALLER_PID 2>/dev/null || true
        wait $INSTALLER_PID 2>/dev/null || true
    fi
}

handle_interrupt() {
    echo ""
    echo "  Caught Ctrl-C, stopping..."
    kill_installer_and_tail
    cleanup
    
    # Reset terminal
    printf "\033[?25h\033[?7h\033[r" >&2
    exit 130
}

is_installed() {
    pkgutil --pkg-info com.apple.pkg.CLTools_Executables &>/dev/null || \
    [ -e "/Library/Developer/CommandLineTools/usr/bin/clang" ]
}

# === MAIN ===
main() {
    # === SETUP PHASE ===
    clear
    
    # Print header
    cat << 'EOF'
═══════════════════════════════════════════════════════════════
              Command Line Tools Installation
═══════════════════════════════════════════════════════════════

EOF
    
    # Architecture detection
    ARCH=$(uname -m)
    PROC=$([[ "$ARCH" == "arm64" ]] && echo "ARM" || echo "Intel")
    echo "Architecture: $ARCH, Processor: $PROC"
    
    # === ARGUMENT HANDLING ===
    DMG_PATH=""
    if [ -n "${1:-}" ] && [ "$1" != "--no-progress" ]; then
        DMG_PATH="$1"
    fi
    
    # Default DMG path handling
    if [ -z "$DMG_PATH" ]; then
        SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
        MOUNT="$( cd "${SCRIPT_DIR}/.." && pwd )"
        DMG_PATH=$(find "${MOUNT}/software/${PROC}" -name "Command_Line_Tools_*.dmg" -type f | head -n1)
    fi
    
    echo "Using DMG: $DMG_PATH"
    
    # Validate DMG
    if [ ! -f "$DMG_PATH" ]; then 
        echo "✗ Error: DMG not found at $DMG_PATH" >&2
        exit 1
    fi
    
    if [ ! -r "$DMG_PATH" ]; then
        echo "✗ Error: DMG not readable" >&2
        ls -la "$DMG_PATH" >&2
        exit 1
    fi

    # Simple mode
    if [ "${1:-}" = "--no-progress" ]; then
        if is_installed; then
            echo "✓ Command Line Tools already installed."
            exit 0
        fi
        
        echo ""
        echo "Running in simple mode..."
        
        # Mount DMG
        echo "  • Mounting DMG..."
        MOUNT_PATH="/Volumes/CLT_$$"
        hdiutil mount -readonly -quiet -nobrowse -mountpoint "$MOUNT_PATH" "$DMG_PATH" || {
            echo "  ✗ Mount failed" >&2
            exit 1
        }
        
        PKG_PATH=$(find "$MOUNT_PATH" -name "*.pkg" -type f | head -n1)
        
        # Run installer with direct output
        echo "  • Running installer..."
        sudo installer -pkg "$PKG_PATH" -target / -verboseR
        
        hdiutil detach "$MOUNT_PATH" 2>/dev/null || true
        
        # Check if installed
        if is_installed; then
            echo "  ✓ Command Line Tools installed successfully!"
        else
            echo "  ✗ Installation failed" >&2
            exit 1
        fi
        
        exit 0
    fi

    # Check if already installed
    if is_installed; then
        echo "✓ Command Line Tools already installed."
        if path=$(xcode-select --print-path 2>/dev/null); then
            echo "  Path: $path"
        fi
        exit 0
    fi

    echo "✓ Command Line Tools not detected. Proceeding with installation..."
    echo ""
    
    # Set up Ctrl-C trap BEFORE any background processes
    trap handle_interrupt SIGINT
    
    # Create progress file
    echo "  • Creating progress indicator file..."
    sudo touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
    
    # Clean up existing mounts
    echo "  • Checking for existing mounts..."
    MOUNTED_IN_SCRIPT=false
    EXISTING_MOUNTS=$(hdiutil info | grep -B 5 "$DMG_PATH" | grep '^/Volumes/' | awk '{print $NF}' || true)
    
    if [ -n "$EXISTING_MOUNTS" ]; then
        echo "  • Unmounting existing mounts..."
        echo "$EXISTING_MOUNTS" | while IFS= read -r mount_point; do
            if [ -n "$mount_point" ]; then
                echo "    - $mount_point"
                hdiutil detach "$mount_point" 2>/dev/null || true
            fi
        done
        sleep 2
    fi
    
    # Mount DMG
    echo "  • Mounting DMG..."
    MOUNT_PATH="/Volumes/CLT_$$"
    
    if ! hdiutil mount -readonly -quiet -nobrowse -mountpoint "$MOUNT_PATH" "$DMG_PATH"; then
        echo "  • Mount failed. Trying standard attach..." >&2
        MOUNT_OUTPUT=$(hdiutil attach -nobrowse "$DMG_PATH" 2>&1)
        
        if [ $? -ne 0 ]; then
            echo "  ✗ ERROR: Failed to mount DMG" >&2
            exit 1
        fi
        
        MOUNTED_IN_SCRIPT=true
        MOUNT_PATH=$(echo "$MOUNT_OUTPUT" | grep '/Volumes/' | awk '{print $NF}' | tail -n1)
        
        if [ -z "$MOUNT_PATH" ]; then
            sleep 1
            MOUNT_PATH=$(find /Volumes -maxdepth 1 -type d -name "*Command*Line*" | head -n1)
        fi
    else
        MOUNTED_IN_SCRIPT=true
    fi
    
    if [ ! -d "$MOUNT_PATH" ]; then
        echo "  ✗ ERROR: Mount point doesn't exist: $MOUNT_PATH" >&2
        exit 1
    fi
    
    echo "  • Mounted at: $MOUNT_PATH"
    
    # Find package
    PKG_PATH=$(find "$MOUNT_PATH" -maxdepth 1 -name "*.pkg" -type f | head -n1)
    if [ -z "$PKG_PATH" ]; then
        echo "  ✗ ERROR: No .pkg file found in $MOUNT_PATH" >&2
        exit 1
    fi
    
    # === SCROLLING WINDOW WITH HEADER AND FOOTER ===
    LOG_FILE="/tmp/clt_install_$(date +%Y%m%d_%H%M%S).log"
    echo "  • Installing: $(basename "$PKG_PATH")"
    echo "  • Log file: $LOG_FILE"
    echo ""
    
    # Get terminal dimensions
    CURRENT_LINE=$(tput lines 2>/dev/null || echo 24)
    WINDOW_START_LINE=$((CURRENT_LINE - 12))
    
    # Set scrolling region
    printf "\033[${WINDOW_START_LINE};${CURRENT_LINE}r"
    
    # Move to start of scrolling region
    printf "\033[${WINDOW_START_LINE};0H"
    
    WINDOW_HEIGHT=10
    
    # Start installer
    sudo installer -pkg "$PKG_PATH" -target / -verboseR > "$LOG_FILE" 2>&1 &
    INSTALLER_PID=$!
    
    # Tail process with header and footer
    {
        sleep 2
        
        display_window() {
            # Move to window start
            printf "\033[${WINDOW_START_LINE};0H\033[J"
            
            # Print header (this stays visible in the scrolling window)
            echo "═══════════════════════════════════════════════════════════════"
            echo "              LIVE INSTALLATION PROGRESS"
            echo "═══════════════════════════════════════════════════════════════"
            echo ""
            
            # Show log lines (leave room for footer)
            if [ -f "$LOG_FILE" ]; then
                tail -n $((WINDOW_HEIGHT - 5)) "$LOG_FILE" 2>/dev/null || echo "Waiting..."
            else
                echo "Waiting for installer to start..."
            fi
            
            # Print footer at bottom of window
            echo "───────────────────────────────────────────────────────────────"
            echo " PID: $INSTALLER_PID | Press Ctrl+C to cancel"
        }
        
        display_window
        
        LAST_LINE_COUNT=0
        
        while kill -0 "$INSTALLER_PID" 2>/dev/null; do
            if [ -f "$LOG_FILE" ]; then
                CURRENT_LINE_COUNT=$(wc -l < "$LOG_FILE")
                
                if [ $CURRENT_LINE_COUNT -gt $LAST_LINE_COUNT ]; then
                    display_window
                    LAST_LINE_COUNT=$CURRENT_LINE_COUNT
                fi
            fi
            
            sleep 0.5
        done
        
        display_window
        
    } &
    
    TAIL_PID=$!
    
    # Wait for installer
    wait "$INSTALLER_PID"
    INSTALL_RESULT=$?
    
    # Reset scrolling region
    printf "\033[r"
    
    # Clean up tail
    kill "$TAIL_PID" 2>/dev/null
    wait "$TAIL_PID" 2>/dev/null
    
    # Clear and show final status
    printf "\033[2J\033[H"
    
    if [ $INSTALL_RESULT -ne 0 ]; then
        echo "✗ ERROR: Installer failed" >&2
        exit 1
    fi
    
    # Verify
    if is_installed; then
        echo "✅ Command Line Tools installed successfully!"
        if path=$(xcode-select --print-path 2>/dev/null); then
            echo "Path: $path"
        fi
    else
        echo "❌ Verification failed" >&2
        exit 1
    fi
    
    echo "Full log: $LOG_FILE"
}

trap cleanup EXIT
main "$@"

