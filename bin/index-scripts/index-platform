#!/bin/bash

START_TIME=$(date +%s)

# Detect script location and calculate base directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(cd ""${SCRIPT_DIR}"/.." && pwd)"

# Allow override via environment
MOUNT_DIR="${MOUNT_DIR:-${BASE_DIR}}"

# Parse optional output file argument
OUTPUT_FILE=""
if [[ $# -gt 0 ]]; then
	OUTPUT_FILE="${1}"
fi

# Get the freeze commit from homebrew-core repo
HOMEBREW_CORE_DIR="${MOUNT_DIR}/repos/homebrew-core"
if [[ ! -d "${HOMEBREW_CORE_DIR}" ]]; then
	echo "ERROR: Homebrew core repository not found at ${HOMEBREW_CORE_DIR}"
	exit 1
fi

FREEZE_COMMIT=$(cd "${HOMEBREW_CORE_DIR}" && git rev-parse --short HEAD 2>/dev/null)
if [[ -z "${FREEZE_COMMIT}" ]]; then
	echo "ERROR: Could not determine freeze commit from ${HOMEBREW_CORE_DIR}"
	exit 1
fi

# Detect current platform
if [[ $(uname -m) == "arm64" ]]; then
	ARCH="arm64"
	PLATFORM_PATTERNS=("arm64_monterey:" "monterey:" "all:")
	WRONG_ARCH="x86_64"
else
	ARCH="x86_64"
	PLATFORM_PATTERNS=("monterey:" "x86_64_monterey:" "all:")
	WRONG_ARCH="arm64"
fi

echo "Detecting platform bottles for: macOS Monterey ${ARCH}"
echo "Using repository at commit: ${FREEZE_COMMIT}"

# Input and output files
ALL_FILE="${MOUNT_DIR}/repos/${FREEZE_COMMIT}_all"
if [[ -n "${OUTPUT_FILE}" ]]; then
	NOPLATFORM_FILE="${OUTPUT_FILE}"
	echo "Output will be saved to: ${NOPLATFORM_FILE}"
else
	NOPLATFORM_FILE="${MOUNT_DIR}/repos/${FREEZE_COMMIT}_noplatform"
fi

if [[ ! -f "${ALL_FILE}" ]]; then
	echo "ERROR: All formulae index not found at ${ALL_FILE}"
	echo "Run the following to generate it:"
	echo "  brew formula --eval-all --format=name > \""${ALL_FILE}"\""
	exit 1
fi

# Clear output file and write CSV header
echo "# fields: formula,platforms" >"${NOPLATFORM_FILE}"

echo "Scanning formula files for platform bottles..."

# Process each formula
TOTAL=0
NOPLATFORM=0

while IFS= read -r formula; do
	((TOTAL++))

	# Find the formula file (handle both old flat structure and new nested structure)
	FORMULA_FILE=""
	if [[ -f "${HOMEBREW_CORE_DIR}"/Formula/"${formula}".rb ]]; then
		FORMULA_FILE="${HOMEBREW_CORE_DIR}/Formula/${formula}.rb"
	else
		# New nested structure: formula name starts with letter/lib
		FIRST_CHAR="${formula:0:1}"
		if [[ -f "${HOMEBREW_CORE_DIR}"/Formula/"${FIRST_CHAR}"/"${formula}".rb ]]; then
			FORMULA_FILE="${HOMEBREW_CORE_DIR}/Formula/${FIRST_CHAR}/${formula}.rb"
		elif [[ "${formula}" == lib* ]] && [[ -f "${HOMEBREW_CORE_DIR}"/Formula/lib/"${formula}".rb ]]; then
			FORMULA_FILE="${HOMEBREW_CORE_DIR}/Formula/lib/${formula}.rb"
		fi
	fi

	if [[ -z "${FORMULA_FILE}" ]]; then
		echo "  Warning: Could not find formula file for: ${formula}" >&2
		continue
	fi

	# Check for architecture-specific requirements (e.g., depends_on arch: :arm64)
	if grep -qE "depends_on arch: :${WRONG_ARCH}" "${FORMULA_FILE}"; then
		# Formula requires the opposite architecture
		echo "${formula},arch:${WRONG_ARCH}" >>"${NOPLATFORM_FILE}"
		((NOPLATFORM++))
		# Progress indicator every 100 formulae
		if ((TOTAL % 100 == 0)); then
			echo "  Processed ${TOTAL} formulae (${NOPLATFORM} without platform bottles)..." >&2
		fi
		continue
	fi

	# Check for OS-specific requirements (Linux-only or macOS-only)
	if grep -qE "depends_on :linux" "${FORMULA_FILE}"; then
		# Formula is Linux-only
		echo "${formula},linux-only" >>"${NOPLATFORM_FILE}"
		((NOPLATFORM++))
		# Progress indicator every 100 formulae
		if ((TOTAL % 100 == 0)); then
			echo "  Processed ${TOTAL} formulae (${NOPLATFORM} without platform bottles)..." >&2
		fi
		continue
	fi

	# Check if formula has a bottle block and if it has our platform
	if grep -q "bottle do" "${FORMULA_FILE}"; then
		# Has a bottle block, check if it has monterey bottles
		HAS_PLATFORM=false
		for pattern in "${PLATFORM_PATTERNS[@]}"; do
			if grep -q "${pattern}" "${FORMULA_FILE}"; then
				HAS_PLATFORM=true
				break
			fi
		done

		if [[ "${HAS_PLATFORM}" == false ]]; then
			# Extract all platform names from the bottle block
			PLATFORMS=$(grep -A 50 "bottle do" "${FORMULA_FILE}" | grep -E "^\s+(sha256|root_url)" | grep -oE "(arm64_[a-z_]+|x86_64_[a-z_]+|[a-z_]+):" | sed 's/:$//' | grep -v "^sha256$" | grep -v "^cellar$" | grep -v "^root_url$" | sort -u | tr '\n' '|' | sed 's/|$//')
			echo "${formula},${PLATFORMS}" >>"${NOPLATFORM_FILE}"
			((NOPLATFORM++))
		fi
	else
		# No bottle block at all - might be source-only
		echo "${formula}," >>"${NOPLATFORM_FILE}"
		((NOPLATFORM++))
	fi

	# Progress indicator every 100 formulae
	if ((TOTAL % 100 == 0)); then
		echo "  Processed ${TOTAL} formulae (${NOPLATFORM} without platform bottles)..." >&2
	fi
done <"${ALL_FILE}"

END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
echo "=== Summary ==="
echo "Total formulae: ${TOTAL}"
echo "Without Monterey ${ARCH} bottles: ${NOPLATFORM}"
echo "With platform bottles: $((TOTAL - NOPLATFORM))"
echo "Results saved to: ${NOPLATFORM_FILE}"
echo "Time elapsed: ${ELAPSED} seconds"