#!/usr/bin/env bash

set -euo pipefail

MOUNT_DIR="${MOUNT_DIR:-/Volumes/Monterey}"

# Get the freeze commit from homebrew-cask repo
HOMEBREW_CASK_DIR="${MOUNT_DIR}/repos/homebrew-cask"
if [[ ! -d ${HOMEBREW_CASK_DIR} ]]; then
	echo "ERROR: Homebrew cask repository not found at ${HOMEBREW_CASK_DIR}"
	exit 1
fi

FREEZE_COMMIT=$(cd "${HOMEBREW_CASK_DIR}" && git rev-parse --short HEAD 2>/dev/null)
if [[ -z ${FREEZE_COMMIT} ]]; then
	echo "ERROR: Could not determine freeze commit from ${HOMEBREW_CASK_DIR}"
	exit 1
fi

echo "Homebrew Cask freeze commit: ${FREEZE_COMMIT}"

# Output file
OUTPUT_FILE="${MOUNT_DIR}/repos/${FREEZE_COMMIT}_casks_all"

# Check if Casks directory exists
CASKS_DIR="${HOMEBREW_CASK_DIR}/Casks"
if [[ ! -d ${CASKS_DIR} ]]; then
	echo "ERROR: Casks directory not found at ${CASKS_DIR}"
	exit 1
fi

echo "Indexing casks from ${CASKS_DIR}..."

# Find all .rb files recursively under Casks/, extract cask names
# Cask files are named like: 1password.rb, visual-studio-code.rb, etc.
# We want just the basename without .rb extension
find "${CASKS_DIR}" -type f -name "*.rb" -print0 | \
	xargs -0 -n 1 basename | \
	sed 's/\.rb$//' | \
	sort -u > "${OUTPUT_FILE}"

CASK_COUNT=$(wc -l < "${OUTPUT_FILE}" | tr -d ' ')

echo "Indexed ${CASK_COUNT} casks to: ${OUTPUT_FILE}"
echo "Sample casks:"
head -10 "${OUTPUT_FILE}"
