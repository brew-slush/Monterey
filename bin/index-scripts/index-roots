#!/usr/bin/env bash

START_TIME=$(date +%s)

MOUNT_DIR="${MOUNT_DIR:-/Volumes/Monterey}"

export HOMEBREW_NO_ENV_HINTS=1

# Get the freeze commit from homebrew-core repo
HOMEBREW_CORE_DIR="${MOUNT_DIR}/repos/homebrew-core"
if [[ ! -d ${HOMEBREW_CORE_DIR} ]]; then
	echo "ERROR: Homebrew core repository not found at ${HOMEBREW_CORE_DIR}"
	exit 1
fi

FREEZE_COMMIT=$(cd "${HOMEBREW_CORE_DIR}" && git rev-parse --short HEAD 2>/dev/null)
if [[ -z ${FREEZE_COMMIT} ]]; then
	echo "ERROR: Could not determine freeze commit from ${HOMEBREW_CORE_DIR}"
	exit 1
fi

USES_FILE="${MOUNT_DIR}/repos/${FREEZE_COMMIT}_uses"
CACHE_FILE="${MOUNT_DIR}/repos/${FREEZE_COMMIT}_roots"

# Check if uses file exists
if [[ ! -f ${USES_FILE} ]]; then
	echo "ERROR: Dependents index not found at ${USES_FILE}" >&2
	echo "Please run index-dependents first" >&2
	exit 1
fi

# Check if cache file exists
if [[ ! -f ${CACHE_FILE} ]]; then
	echo "Generating root formula list for commit ${FREEZE_COMMIT}"
	echo "(This is a one-time operation per freeze commit)"

	# Extract formulae with no dependents (lines with just "formula," or "formula" with no comma)
	# Format is: formula,dep1,dep2,... so no dependents means just "formula" with nothing after
	grep -v '^#' "${USES_FILE}" | awk -F',' '$2 == "" {print $1}' | sort >"${CACHE_FILE}"

	echo "Cache generated at ${CACHE_FILE}"
	echo "Found $(wc -l <"${CACHE_FILE}") root formulae (nothing depends on them)"
else
	echo "Using cached formula list for commit ${FREEZE_COMMIT}"
	echo "Cache file: ${CACHE_FILE}"
fi

# Now filter to show only uninstalled formulae
INSTALLED=$(brew list --formula 2>/dev/null | sort)

while read -r formula; do
	if ! echo "${INSTALLED}" | grep -q "^${formula}$"; then
		echo "${formula}"
	fi
done <"${CACHE_FILE}"

# Calculate and display elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
echo "" >&2
echo "Total time: ${ELAPSED} seconds" >&2
